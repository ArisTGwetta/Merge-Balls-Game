<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Merge Balls: Ascension v4</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align to start to better handle smaller screens */
            min-height: 100vh;
            margin: 0;
            background-color: #2c3e50;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            overflow: hidden; /* Prevent body scroll */
            touch-action: none;
            padding-top: 5px; /* Add a little padding at the top */
            padding-bottom: 5px; /* Add a little padding at the bottom */
            box-sizing: border-box; /* Include padding in height calculations */
        }

        #game-container {
            position: relative;
            background-color: #ecf0f1;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            padding: 10px; /* Reduced padding slightly to save vertical space */
            box-sizing: border-box; /* Include padding in width/height */
            
            /* === VERTICAL RESPONSIVENESS FIXES START HERE === */
            /* New strategy: Maximize usage of available width AND height */
            /* Use clamp to manage game container size */
            width: clamp(280px, 95vw, 400px); /* Min 280px, max 400px, responsive to 95% viewport width */
            
            /* Calculate height based on available vertical space, keeping aspect ratio */
            /* This is more complex because of dynamic browser UI. */
            /* We'll use JS to adjust height for the game-canvas itself. */
            height: calc(100vh - 20px); /* Take up almost all viewport height, leaving small margin */
            max-height: 700px; /* Max height for very tall screens */
            /* Min-height to ensure it doesn't disappear on tiny screens */
            min-height: 500px; 
            
            /* Flex-grow to fill available space between items if body is 'justify-content: space-between' */
            flex-grow: 1; 
            /* === VERTICAL RESPONSIVENESS FIXES END HERE === */

            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Header Layout */
        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 8px; /* Slightly reduced margin */
            padding: 0 10px;
            box-sizing: border-box;
            /* Give the header a fixed height so canvas can calculate remaining space */
            min-height: 60px; /* Ensure header has space even with fluid fonts */
        }

        .score-box {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            line-height: 1.1; /* Tighter line height for scores */
        }

        .score-box:last-of-type {
            align-items: flex-end;
        }

        .label {
            font-size: clamp(10px, 2.5vw, 12px); /* Responsive font size */
            color: #7f8c8d;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .value {
            font-size: clamp(20px, 6vw, 28px); /* Responsive font size */
            color: #2c3e50;
            font-weight: 800;
        }
        
        #best-score-box .value {
            color: #3498db;
        }

        #next-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #next-ball-preview {
            /* Responsive next ball size */
            width: clamp(28px, 7vw, 35px);
            height: clamp(28px, 7vw, 35px);
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(12px, 3vw, 14px); /* Responsive font size */
            color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            transition: all 0.2s ease;
        }
        #next-container .label {
            font-size: clamp(8px, 2vw, 10px);
        }

        #game-canvas {
            border: 4px solid #34495e;
            background-color: #fff;
            display: block;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            cursor: crosshair;
            
            /* === VERTICAL RESPONSIVENESS FIXES START HERE === */
            width: 100%; /* Take 100% of the game-container's width */
            /* This height will be adjusted by JavaScript to maintain aspect ratio */
            flex-grow: 1; /* Allow it to grow, but JS will enforce aspect ratio */
            /* Add min-height to prevent it from collapsing if JS is slow */
            min-height: 300px; 
            /* === VERTICAL RESPONSIVENESS FIXES END HERE === */
        }

        /* Flash animation for "Ascension" */
        @keyframes flash {
            0% { background-color: #ecf0f1; }
            25% { background-color: #2ecc71; } /* Success Green */
            50% { background-color: #ecf0f1; }
            75% { background-color: #2ecc71; }
            100% { background-color: #ecf0f1; }
        }
        .flash-effect {
            animation: flash 0.6s ease-out;
        }

    </style>
</head>
<body>
    <div id="game-container">
        
        <div id="header">
            <div class="score-box">
                <span class="label">Score</span>
                <span id="current-score" class="value">0</span>
            </div>
            <div id="next-container">
                <div id="next-ball-preview"></div>
                <span class="label" style="font-size: 10px; margin-top:2px;">Next Drop</span>
            </div>
            <div class="score-box" id="best-score-box">
                <span class="label">Best</span>
                <span id="best-score" class="value">0</span>
            </div>
        </div>

        <canvas id="game-canvas"></canvas>
    </div>

    <script>
        // --- CONFIGURATION ---
        // These constants define the *internal* coordinate system for physics and drawing (0 to 400 on X, 0 to 600 on Y).
        const INTERNAL_GAME_WIDTH = 400;
        const INTERNAL_GAME_HEIGHT = 600; // Original aspect ratio 400:600 = 2:3
        const MIN_BALL_SIZE = 20;
        const GRAVITY = 0.55; 
        const FRICTION = 0.96; 
        const WALL_BOUNCE = 0.4;
        const PHYSICS_SUBSTEPS = 8; 
        const ASCENSION_TARGET_VALUE = 11; // The value that triggers board clear (Dark Green Ball)

        // 11 Colors (1-11)
        const BALL_COLORS = [
            '
